{% comment %}
  A dynamic and fully automatic sidebar.
  - Uses an if/elsif block for custom section titles.
  - Sorts categories and pages based on file/folder names.
  - No "order" or "category_order" front matter is needed.
{% endcomment %}

{%- assign section_name = include.section -%}
{%- assign collection = site[section_name] -%}

<aside id="sidebar" class="sidebar">

  {%- if collection -%}

    {% comment %} Custom titles for each section, as per your original file. {% endcomment %}
    {%- if section_name == "guide" -%}
      <h3 class="sidebar-title">The Thinking Guide</h3>
    {%- elsif section_name == "casestudies" -%}
      <h3 class="sidebar-title">Selected Case Studies</h3>
    {%- elsif section_name == "articles" -%}
      <h3 class="sidebar-title">Collected Articles</h3>
    {%- else -%}
      <h3 class="sidebar-title">{{ section_name | replace: '-', ' ' | capitalize }}</h3>
    {%- endif -%}
    
    <ul class="sidebar-nav">
      
      {% comment %} Find the main intro page (the index.md in the collection's root). {% endcomment %}
      {%- assign intro_page = collection | where_exp: "item", "item.path contains 'index.md'" | first -%}
      {%- if intro_page -%}
        <li class="sidebar-group">
          <h4>Introduction</h4>
          <a href="{{ intro_page.url | relative_url }}"
             {% if page.url == intro_page.url %}class="active"{% endif %}>
            {{ intro_page.title }}
          </a>
        </li>
      {%- endif -%}
      
      {% comment %} Get all other pages by excluding the intro page's URL. {% endcomment %}
      {%- assign categorized_pages = collection | where_not: "url", intro_page.url -%}
      
      {% comment %} Group the remaining pages by their category. {% endcomment %}
      {%- assign grouped_pages = categorized_pages | group_by: "category" -%}
      
      {% comment %} Sort the GROUPS alphabetically by their name (respects "01-", "02-"). {% endcomment %}
      {%- assign sorted_groups = grouped_pages | sort: "name" -%}
      
      {%- for group in sorted_groups -%}
        <li class="sidebar-group">
          <h4>{{ group.name | replace: '-', ' ' | capitalize }}</h4>
          <ul>
            {% comment %} Sort the PAGES within each group by their full path (respects "10-", "20-"). {% endcomment %}
            {%- assign items_in_group = group.items | sort: "path" -%}
            {%- for item in items_in_group -%}
              <li>
                <a href="{{ item.url | relative_url }}"
                   {% if page.url == item.url %}class="active"{% endif %}>
                  {{ item.title }}
                </a>
              </li>
            {%- endfor -%}
          </ul>
        </li>
      {%- endfor -%}

    </ul>
  {%- endif -%}
</aside>