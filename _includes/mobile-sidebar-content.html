{%- comment -%}
  A fully automatic sidebar for MOBILE.
  It groups and sorts based on file/folder names.
  No "order" or "category_order" front matter is needed.
{%- endcomment -%}

{%- assign section_name = include.section -%}
{%- assign collection = site[section_name] -%}

{%- if collection -%} 
  <div class="mobile-sidebar-content">
    <h4>{{ section_name | replace: '-', ' ' | capitalize }}</h4>
    
    <ul class="mobile-sidebar-nav">
      
      {# Find the main intro page (the index.md in the collection's root) #}
      {%- assign intro_page = collection | where_exp: "item", "item.path contains 'index.md'" | first -%}
      {%- if intro_page -%}
        <li class="mobile-sidebar-intro">
          <a href="{{ intro_page.url | relative_url }}"
             {% if page.url == intro_page.url %}class="active"{% endif %}>
            <strong>{{ intro_page.title }}</strong>
          </a>
        </li>
      {%- endif -%}
      
      {# Get all other pages (that are not the main index.md) #}
      {%- assign categorized_pages = collection | where_exp: "item", "item.path contains 'index.md' == false" -%}
      
      {# --- THE NEW LOGIC IS HERE --- #}
      {# 1. Group pages by their category (from front matter) #}
      {%- assign grouped_pages = categorized_pages | group_by: "category" -%}
      
      {# 2. Sort the GROUPS alphabetically by their name. This respects the "01-", "02-" folder names. #}
      {%- assign sorted_groups = grouped_pages | sort: "name" -%}
      
      {%- for group in sorted_groups -%}
        <li class="mobile-sidebar-group">
          <h5>{{ group.name | replace: '-', ' ' | capitalize }}</h5>
          <ul>
            {# 3. Sort the PAGES WITHIN each group by their full path. This respects "10-", "20-" file names. #}
            {%- assign items_in_group = group.items | sort: "path" -%}
            {%- for item in items_in_group -%}
              <li>
                <a href="{{ item.url | relative_url }}"
                   {% if page.url == item.url %}class="active"{% endif %}>
                  {{ item.title }}
                </a>
              </li>
            {%- endfor -%}
          </ul>
        </li>
      {%- endfor -%}

    </ul>
  </div>
{%- endif -%}

